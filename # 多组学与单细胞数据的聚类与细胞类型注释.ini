# 多组学与单细胞数据处理流程解析

下面的解释基于你提供的日志内容以及代码，分为两部分说明：**多组学数据处理**和**单细胞数据处理**。

---

## 一、多组学数据处理（Multiome Data Processing）

### 数据来源与文件准备
- **数据来源**  
  数据来自 10x Genomics，包括 PBMC、brain 和 jejunum 三个组织的单细胞核多组学数据。每个数据集下载了：
  - 带有 “filtered_feature_bc_matrix.h5” 后缀的 RNA 数据文件
  - 相应的 ATAC fragments 文件（例如：`pbmc_unsorted_10k_atac_fragments.tsv.gz`）
  - 峰注释文件（如 `pbmc_atac_peak_annotations.tsv`），用于后续将 ATAC 峰注释到基因

### 数据预处理流程
1. **文件完整性检查与内存估算**  
   - 程序使用 `check_file_integrity` 对每个 h5 文件和 fragments 文件进行存在性、大小及可读性检查。  
   - 通过 `estimate_memory_usage` 对所有输入文件的总大小进行粗略估计（日志中估计为 47.92 GB），但系统实际可用内存仅 2.40 GB，因此发出内存紧张的警告。

2. **RNA 数据质控与标准化**  
   - 通过 Scanpy 对 RNA 数据进行质控：  
     - 过滤掉线粒体 UMI 占比超过设定阈值（例如 PBMC 使用 12%，brain 使用 10%）的细胞  
     - 过滤掉检测到基因数量低于设定阈值的细胞（PBMC 至少 200 个基因；brain 至少 500 个；jejunum 至少 300 个）  
   - 对数据进行库大小归一化和 log 转换，并使用默认参数鉴定高变异基因（HVG）。

3. **ATAC 数据预处理与峰注释**  
   - 使用 `load_10x_atac` 从 h5 文件中读取 ATAC 数据（专门提取“Peaks”部分），并对存在的 fragments 文件进行 Tabix 索引创建。  
   - 通过 `optimize_atac_preprocessing` 对 ATAC 数据执行低覆盖和低质量峰/细胞的过滤，再利用 TF-IDF 转换和截断 SVD（LSI）进行降维。  
   - 利用 `annotate_peaks_to_genes` 对每个 ATAC 峰进行注释（采用直接匹配、基于坐标匹配等策略），为后续构建基因活性矩阵提供基础。

4. **数据整合（采用 WNN 方法）**  
   - 整合采用加权最近邻（WNN）方法：  
     - 分别对 RNA 数据执行 PCA 降维，对 ATAC 数据（或计算的 gene_activity）执行 LSI 降维  
     - 对两个模态分别计算 KNN 邻域图，再将两个邻域图的归一化距离矩阵以 0.5 权重加权组合，构建加权连接矩阵  
     - 生成整合后的 AnnData 对象，并提前计算 UMAP 嵌入，供后续聚类与可视化使用  
   - 日志显示各组织（PBMC、brain、jejunum）均成功使用 WNN 方法完成整合，并保存了检查点（如 `pbmc_integrated_20250316_140056.h5ad`）。

5. **聚类与细胞类型注释**  
   - 利用 Leiden 算法对整合后的数据进行聚类  
   - 采用差异表达分析（例如 Mann-Whitney 检验）获得各聚类中排名靠前的基因  
   - 结合预定义的细胞类型标记基因（例如 PBMC 中的 B cell、CD14+ monocyte、CD4 T cell、CD8 T cell；brain 和 jejunum 有各自标记）对聚类进行手动注释

6. **结果汇总与可视化**  
   - 每个组织的数据整合后均保存为检查点文件，同时建立指向最新检查点的符号链接  
   - 所有组织的细胞类型计数汇总生成 CSV 文件（如 `cell_type_summary.csv`），并使用 Seaborn 绘制细胞类型热图与条形图保存为 PNG 文件  
   - 最终生成一个 JSON 文件（`analysis_summary.json`）记录所有数据集名称、总细胞数、完成时间及运行时长

---

## 二、单细胞数据处理（Single-Cell Data Processing）

### 数据来源与预处理
- **数据来源**  
  数据来自 10x Genomics，包含 PBMC 单细胞基因表达数据以及对应的抗体衍生标签（ADT），但你实际使用中未启用 ADT 部分（因为太少了）。
  
- **数据读取与完整性检查**  
  - 使用 `process_singlecell_adt_data` 函数读取单细胞数据 h5 文件。  
  - 首先使用 h5py 检查文件完整性，确保文件内容有效。

### 数据分离、标准化与聚类
1. **分离 RNA 与 ADT 数据**  
   - 根据 `feature_types` 列将数据分为 RNA 部分和 ADT 部分。  
   - 由于未使用 ADT 部分，后续处理主要基于 RNA 数据进行。

2. **RNA 数据质控与标准化**  
   - 计算 QC 指标（例如总计数、检测到的基因数、线粒体 UMI 比例），并绘制 violin 图对质量进行直观展示  
   - 过滤掉线粒体 UMI 比例超过 5% 的细胞以及总计数异常（可能为多重核）的细胞  
   - 对 RNA 数据进行归一化与 log 转换，并鉴定高变异基因

3. **降维、聚类与可视化**  
   - 计算 RNA 数据的 PCA，构建邻域图  
   - 利用 Leiden 算法对细胞进行聚类，并计算 UMAP 嵌入以便进行可视化  
   - 聚类结果结合预定义的 PBMC 细胞类型标记基因进行注释，例如 B cell、CD14+ monocyte、CD4 T cell 和 CD8 T cell

4. **ADT 数据处理（未使用）**  
   - 虽然设计了 ADT 数据的 DSB 标准化流程，但日志中未显示 ADT 特定处理信息，说明在实际使用中未启用 ADT 部分  
   - 当 ADT 数据不可用时，流程自动回退仅使用 RNA 数据进行聚类和细胞类型注释

### 结果保存
- 整个单细胞数据处理流程完成后，生成的 AnnData 对象以及细胞类型统计数据分别保存为 h5ad 文件和 CSV 文件。
- 处理完成后，日志显示检查点文件如 `pbmc_sc_adt_20250316_194642.h5ad` 已成功创建，并输出了详细的细胞类型统计信息。

---

## 总结

- **多组学数据处理**  
  - 数据来自 PBMC、brain 和 jejunum 三个组织，包含 RNA 和 ATAC 信息。  
  - 数据预处理包括文件完整性检查、质控、标准化、降维以及通过 WNN 方法进行 RNA 与 ATAC 数据整合。  
  - 经过整合后，使用 Leiden 聚类和差异表达分析，对聚类进行细胞类型注释，最终生成了细胞类型统计表和可视化图。

- **单细胞数据处理**  
  - 数据来源为 PBMC 单细胞基因表达（ADT 数据未使用），流程同样包括质控、归一化、降维、聚类及细胞类型注释。  
  - 当 ADT 数据不可用时，流程自动回退至仅使用 RNA 数据，并成功生成聚类和 UMAP 可视化结果。